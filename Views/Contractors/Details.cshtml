@using System.Security.Claims
@model JonyBalls3.Models.ContractorProfile

@{
    ViewData["Title"] = "Профиль подрядчика";
}

<div class="container py-4">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body text-center p-4">
                    @if (Model.User?.AvatarUrl != null)
                    {
                        <img src="@Model.User.AvatarUrl" class="rounded-circle mb-3" width="120" height="120">
                    }
                    else
                    {
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width:120px;height:120px;">
                            <i class="fas fa-user-tie fa-4x"></i>
                        </div>
                    }
                    
                    <h4 class="mb-1">@Model.CompanyName</h4>
                    <p class="text-muted mb-2">@Model.Specialization</p>
                    
                    <div class="mb-3">
                        <span class="badge @(Model.Status == JonyBalls3.Models.ContractorStatus.Available ? "bg-success" : 
                                              Model.Status == JonyBalls3.Models.ContractorStatus.Busy ? "bg-warning" : "bg-secondary") fs-6">
                            @(Model.Status == JonyBalls3.Models.ContractorStatus.Available ? "Свободен" :
                              Model.Status == JonyBalls3.Models.ContractorStatus.Busy ? "Занят" : "Недоступен")
                        </span>
                        @if (Model.IsVerified)
                        {
                            <span class="badge bg-info fs-6">
                                <i class="fas fa-check-circle me-1"></i>Верифицирован
                            </span>
                        }
                    </div>

                    <div class="mb-3">
                        <div class="text-warning">
                            @for (int i = 0; i < 5; i++)
                            {
                                if (i < Math.Floor(Model.Rating))
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else if (i < Model.Rating)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                            <span class="text-muted ms-1">(@Model.ReviewsCount отзывов)</span>
                        </div>
                    </div>

                    <ul class="list-unstyled text-start mb-3">
                        <li class="mb-2"><i class="fas fa-clock text-primary me-2"></i>Опыт: @Model.ExperienceYears лет</li>
                        <li class="mb-2"><i class="fas fa-money-bill text-success me-2"></i>Ставка: @Model.HourlyRate.ToString("N0") ₽/час</li>
                        @if (!string.IsNullOrEmpty(Model.Phone))
                        {
                            <li class="mb-2"><i class="fas fa-phone text-info me-2"></i>@Model.Phone</li>
                        }
                        @if (!string.IsNullOrEmpty(Model.Website))
                        {
                            <li class="mb-2"><i class="fas fa-globe text-secondary me-2"></i><a href="@Model.Website" target="_blank">@Model.Website</a></li>
                        }
                    </ul>

                    @if (User.Identity.IsAuthenticated && Model.UserId != User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier))
                    {
                        <button class="btn btn-gradient w-100 invite-contractor" data-id="@Model.Id" data-name="@Model.CompanyName">
                            <i class="fas fa-envelope me-2"></i>Пригласить в проект
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2" style="color: #667eea;"></i>О подрядчике</h5>
                </div>
                <div class="card-body p-4">
                    <p class="mb-0">@(string.IsNullOrEmpty(Model.Description) ? "Описание не добавлено" : Model.Description)</p>
                </div>
            </div>

            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="mb-0"><i class="fas fa-images me-2" style="color: #667eea;"></i>Портфолио</h5>
                </div>
                <div class="card-body p-4">
                    @if (Model.Portfolio == null || !Model.Portfolio.Any())
                    {
                        <p class="text-muted text-center mb-0">Портфолио пусто</p>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var item in Model.Portfolio)
                            {
                                <div class="col-md-4">
                                    <div class="card portfolio-card">
                                        <img src="@item.ImageUrl" class="card-img-top" style="height: 150px; object-fit: cover;" alt="@item.Title">
                                        <div class="card-body p-2">
                                            <p class="small text-muted mb-0">@item.Title</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="mb-0"><i class="fas fa-star me-2" style="color: #667eea;"></i>Отзывы</h5>
                </div>
                <div class="card-body p-4">
                    @if (Model.Reviews == null || !Model.Reviews.Any())
                    {
                        <p class="text-muted text-center mb-0">Пока нет отзывов</p>
                    }
                    else
                    {
                        @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                        {
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <h6 class="mb-1">@review.User?.FullName</h6>
                                        <div class="text-warning small">
                                            @for (int i = 0; i < 5; i++)
                                            {
                                                if (i < review.Rating)
                                                {
                                                    <i class="fas fa-star"></i>
                                                }
                                                else
                                                {
                                                    <i class="far fa-star"></i>
                                                }
                                            }
                                        </div>
                                    </div>
                                    <small class="text-muted">@review.CreatedAt.ToString("dd.MM.yyyy")</small>
                                </div>
                                <p class="mb-0">@review.Comment</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для приглашения -->
<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Приглашение подрядчика</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inviteForm">
                    <input type="hidden" name="contractorId" id="inviteContractorId">
                    <div class="mb-3">
                        <label class="form-label">Подрядчик</label>
                        <input type="text" class="form-control" id="inviteContractorName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Выберите проект</label>
                        <select name="projectId" class="form-select" id="projectSelect" required>
                            <option value="">-- Загрузка проектов --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Сообщение подрядчику</label>
                        <textarea name="message" class="form-control" rows="4" placeholder="Опишите, что нужно сделать..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-gradient" id="sendInviteBtn">Отправить приглашение</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Загрузка проектов пользователя
            function loadProjects() {
                $.get('/Projects/GetUserProjects')
                    .done(function(projects) {
                        var select = $('#projectSelect');
                        select.empty().append('<option value="">-- Выберите проект --</option>');
                        
                        if (projects.length === 0) {
                            select.append('<option value="" disabled>У вас нет активных проектов</option>');
                        } else {
                            projects.forEach(function(p) {
                                select.append('<option value="' + p.id + '">' + p.name + '</option>');
                            });
                        }
                    })
                    .fail(function() {
                        $('#projectSelect').empty().append('<option value="">Ошибка загрузки проектов</option>');
                    });
            }

            // Открытие модального окна приглашения
            $('.invite-contractor').click(function() {
                var id = $(this).data('id');
                var name = $(this).data('name');
                
                $('#inviteContractorId').val(id);
                $('#inviteContractorName').val(name);
                loadProjects();
                
                $('#inviteModal').modal('show');
            });

            // Отправка приглашения
            $('#sendInviteBtn').click(function() {
                var formData = $('#inviteForm').serialize();
                
                $.post('/Invitations/Create', formData)
                    .done(function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                            $('#inviteModal').modal('hide');
                        } else {
                            toastr.error(response.message);
                        }
                    })
                    .fail(function() {
                        toastr.error('Ошибка при отправке приглашения');
                    });
            });
        });
    </script>
}

<style>
    .portfolio-card {
        transition: transform 0.3s;
        cursor: pointer;
    }
    
    .portfolio-card:hover {
        transform: scale(1.05);
        z-index: 10;
    }
</style>